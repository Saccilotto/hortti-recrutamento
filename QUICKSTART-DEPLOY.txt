â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    HORTTI INVENTORY - DEPLOY RÃPIDO                      â•‘
â•‘                    cantinhoverde.app.br - ProduÃ§Ã£o                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš€ DEPLOY EM 5 PASSOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1ï¸âƒ£  SETUP INICIAL (UMA VEZ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Criar backend Terraform (S3 + DynamoDB)
make infra-setup-backend

# Gerar chave SSH
ssh-keygen -t rsa -b 4096 -f ~/.ssh/hortti-prod-key

# Configurar AWS CLI
aws configure
# RegiÃ£o: us-east-2
# Access Key ID: <seu_key_id>
# Secret Access Key: <seu_secret>


2ï¸âƒ£  CONFIGURAR VARIÃVEIS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Terraform
cp infra/terraform/terraform.tfvars.example infra/terraform/terraform.tfvars
vim infra/terraform/terraform.tfvars

Preencher:
  - ssh_public_key      (cat ~/.ssh/hortti-prod-key.pub)
  - allowed_ssh_cidr    (curl ifconfig.me => SEU_IP/32)
  - cloudflare_api_token
  - cloudflare_zone_id

# Ansible
cp infra/ansible/vars/secrets.yml.example infra/ansible/vars/secrets.yml
vim infra/ansible/vars/secrets.yml

Gerar senhas:
  - postgres_password:     openssl rand -base64 32
  - jwt_secret:            openssl rand -base64 32
  - jwt_refresh_secret:    openssl rand -base64 32
  - traefik_dashboard_auth: htpasswd -nb admin SuaSenha


3ï¸âƒ£  PROVISIONAR INFRAESTRUTURA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

make infra-init      # Inicializar Terraform
make infra-plan      # Ver o que serÃ¡ criado
make infra-apply     # Criar recursos (confirmar com ENTER)

# Anotar IP da EC2
make infra-output

# Atualizar inventory Ansible
vim infra/ansible/inventory/hosts.ini
# Trocar YOUR_EC2_PUBLIC_IP pelo IP exibido acima


4ï¸âƒ£  BUILD E PUSH IMAGENS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Configurar variÃ¡veis
export GITHUB_USER="seu-usuario-github"
export GITHUB_TOKEN="ghp_seu_token_aqui"

# Build + Push
make docker-login
make docker-build-push


5ï¸âƒ£  DEPLOY APLICAÃ‡ÃƒO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Testar conectividade
make deploy-check

# Deploy completo
make deploy

# Verificar
make prod-status
make prod-logs


âœ… VERIFICAÃ‡ÃƒO FINAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Acessar URLs (aguardar 2-3 minutos para SSL):

  âœ“ https://cantinhoverde.app.br
  âœ“ https://api.cantinhoverde.app.br/api/health
  âœ“ https://traefik.cantinhoverde.app.br
    User: admin / Password: (definida no htpasswd)


ğŸ“‹ COMANDOS ÃšTEIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Ver IP e URLs
make infra-output

# Status da aplicaÃ§Ã£o
make prod-status

# Logs em tempo real
make prod-logs

# Reiniciar
make prod-restart

# SSH na EC2
ssh -i ~/.ssh/hortti-prod-key.pem ubuntu@<IP_DA_EC2>


ğŸ”„ ATUALIZAR APLICAÃ‡ÃƒO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OpÃ§Ã£o 1 - Local:
  make prod-deploy

OpÃ§Ã£o 2 - GitHub Actions:
  1. Push na branch main (build automÃ¡tico)
  2. Actions â†’ Deploy to Production â†’ Run workflow
  3. Terraform: plan
  4. Deploy app: true
  5. Image tag: latest

OpÃ§Ã£o 3 - SSH Manual:
  ssh -i ~/.ssh/hortti-prod-key.pem ubuntu@<IP>
  cd /opt/hortti-inventory
  docker compose pull
  docker compose up -d


âš ï¸  DESTRUIR INFRAESTRUTURA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# CUIDADO: Isso apaga TUDO!
make infra-destroy


ğŸ› TROUBLESHOOTING RÃPIDO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Problema: SSL nÃ£o funciona
  â†’ dig cantinhoverde.app.br (deve mostrar IP da EC2)
  â†’ Cloudflare: DNS only (proxy OFF)
  â†’ docker compose logs traefik | grep acme

Problema: Containers nÃ£o sobem
  â†’ ssh ubuntu@IP
  â†’ docker compose ps
  â†’ docker compose logs
  â†’ cat .env (verificar variÃ¡veis)

Problema: Ansible nÃ£o conecta
  â†’ chmod 600 ~/.ssh/hortti-prod-key.pem
  â†’ ssh -vvv -i ~/.ssh/hortti-prod-key.pem ubuntu@IP
  â†’ Verificar security group (porta 22)

Problema: Terraform locked
  â†’ cd infra/terraform
  â†’ terraform force-unlock LOCK_ID


ğŸ“š DOCUMENTAÃ‡ÃƒO COMPLETA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  docs/DEPLOYMENT.md      - Guia detalhado com troubleshooting
  docs/SECRETS.md         - GitHub Secrets para CI/CD
  docs/INFRASTRUCTURE.md  - Arquitetura e componentes


ğŸ’° CUSTOS
â•â•â•â•â•â•â•â•â•

  ~$36.94/mÃªs (EC2 t2.medium + EBS + S3 + DynamoDB)

  Reduzir custos:
    - Parar EC2 quando nÃ£o usar (stop/start)
    - Usar t2.micro para staging ($8.47/mÃªs)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Para suporte, consulte: docs/DEPLOYMENT.md

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
